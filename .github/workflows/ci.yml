      - name: Create or find PR + enable auto-merge
        shell: bash
        run: |
          set -e

          HEAD_REF="${GITHUB_REF#refs/heads/}"
          echo "Branch actual: $HEAD_REF"

          # Buscar PR existente
          EXISTING=$(gh pr list --state open --base main --head "$HEAD_REF" | head -n 1)

          if [ -z "$EXISTING" ]; then
            echo "No existe PR, creando uno..."
            PR_URL=$(gh pr create \
              --head "$HEAD_REF" \
              --base main \
              --title "Auto PR: $HEAD_REF → main" \
              --body "Pull request creado automáticamente por CI.")
            echo "Creado PR: $PR_URL"
          else
            echo "PR existente encontrado:"
            echo "$EXISTING"
            PR_URL=$(echo "$EXISTING" | awk '{print $NF}')
            echo "PR ya existe, saliendo sin error."
            exit 0
          fi

          # Extraer número de PR
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')

          if [ -z "$PR_NUMBER" ]; then
            echo "❌ No se pudo extraer el número de PR"
            exit 1
          fi

          echo "PR #$PR_NUMBER procesado"

          echo "Intentando activar auto-merge…"
          if gh pr merge "$PR_NUMBER" --auto --merge; then
            echo "✅ Auto-merge activado"
          else
            echo "⚠ Auto-merge no disponible aún (checks o protecciones faltan)"
          fi
