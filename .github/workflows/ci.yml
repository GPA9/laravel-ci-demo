# Nom "humà" del workflow. Així és com el veurem a la pestanya Actions.
name: CI (Laravel)

on:
  push:
    branches: [ '**' ]
  pull_request:

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, pdo_sqlite
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}

      - name: Install Composer dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: Prepare environment
        run: |
          cp .env.example .env
          php artisan key:generate
          touch database/database.sqlite
          php artisan migrate --force

      - name: Run tests
        run: php artisan test --no-coverage


  create_pr:
    needs: tests
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create or find PR + enable auto-merge
        shell: bash
        run: |
          set -e

          HEAD_REF="${GITHUB_REF#refs/heads/}"
          echo "Branch actual: $HEAD_REF"

          # Buscar PR existente (solo devuelve número o null)
          PR_NUMBER=$(gh pr list \
            --state open \
            --base main \
            --head "$HEAD_REF" \
            --json number \
            --jq '.[0].number')

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "No existe PR, creando uno..."
            PR_NUMBER=$(gh pr create \
              --head "$HEAD_REF" \
              --base main \
              --title "Auto PR: $HEAD_REF → main" \
              --body "Pull request creado automáticamente por CI." \
              --json number \
              --jq '.number')
            echo "Creado PR #$PR_NUMBER"
          else
            echo "PR existente encontrado: #$PR_NUMBER"
          fi

          echo "Intentando activar auto-merge..."
          gh pr merge "$PR_NUMBER" --auto --merge || \
            echo "⚠ Auto-merge no disponible aún (checks faltan o protecciones de rama)."
