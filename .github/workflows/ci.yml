# Nom "humà" del workflow. Així és com el veurem a la pestanya Actions.
name: CI (Laravel)

# Bloc que defineix QUAN s’executa el workflow.
on:
  # Es dispara en push a qualsevol branca
  push:
    branches: [ '**' ]
  # També es dispara quan s’obre/actualitza un pull request.
  pull_request:

# Permisos necessaris per crear PRs i habilitar auto-merge
permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  # Job de tests
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, pdo_sqlite
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}

      - name: Install Composer dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: Prepare environment
        run: |
          cp .env.example .env
          php artisan key:generate
          touch database/database.sqlite
          php artisan migrate --force

      - name: Run tests
        run: php artisan test --no-coverage

  # Job que crea PR y activa auto-merge
  create_pr:
    needs: tests
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create or find PR + enable auto-merge
        shell: bash
        run: |
          set -e

          HEAD_REF="${GITHUB_REF#refs/heads/}"
          echo "Branch actual: $HEAD_REF"

          # Buscar PR existente (texto plano)
          EXISTING=$(gh pr list --state open --base main --head "$HEAD_REF" | head -n 1)

          if [ -z "$EXISTING" ]; then
            echo "No existe PR, creando uno..."
            # Crear PR y capturar la URL
            PR_URL=$(gh pr create \
              --head "$HEAD_REF" \
              --base main \
              --title "Auto PR: $HEAD_REF → main" \
              --body "Pull request creado automáticamente por CI." 2>/dev/null | grep -Eo 'https://github\.com/[^ ]+')
            echo "Creado PR: $PR_URL"
          else
            echo "PR existente encontrado:"
            echo "$EXISTING"
            # Tomar la última columna como URL del PR
            PR_URL=$(echo "$EXISTING" | awk '{print $NF}')
          fi

          # Extraer número de PR de la URL
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')

          if [ -z "$PR_NUMBER" ]; then
            echo "❌ No se pudo extraer el número de PR"
            exit 1
          fi

          echo "PR #$PR_NUMBER procesado"

          # Intentar activar auto-merge
          echo "Intentando activar auto-merge…"
          if gh pr merge "$PR_NUMBER" --auto --merge; then
            echo "✅ Auto-merge activado"
          else
            echo "⚠ Auto-merge no disponible aún (checks o protecciones faltan)"
          fi
