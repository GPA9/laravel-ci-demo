name: CI (Laravel)

on:
  push:
    branches: ['**']
  pull_request:

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, bcmath, pdo_sqlite
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}

      - name: Install Composer dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: Prepare environment
        run: |
          cp .env.example .env
          php artisan key:generate
          mkdir -p database
          touch database/database.sqlite
          php artisan migrate --force

      - name: Run tests
        # --no-coverage: no calculem cobertura (més ràpid per a una demo bàsica).
        # (Laravel invoca PHPUnit o Pest segons la config del projecte.)
        # DESCOMENTA la línea siguiente para FORZAR QUE LOS TESTS FALLEN (para pruebas de CI):
        run: php artisan test --no-coverage


  create_pr:
    needs: tests
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create or find PR + enable auto-merge
        shell: bash
        run: |
          set -e

          HEAD_REF="${GITHUB_REF#refs/heads/}"
          echo "Branch actual: $HEAD_REF"

          # 1) Buscar PR existente
          PR_NUMBER=$(gh pr list --head "$HEAD_REF" --base main --state open --json number --jq '.[0].number')

          # 2) Si no existe, crearlo
          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "No existe PR, creando uno..."
            PR_NUMBER=$(gh pr create \
              --head "$HEAD_REF" \
              --base main \
              --title "Auto PR: $HEAD_REF → main" \
              --body "Pull request creado automáticamente por CI." \
              --json number --jq '.number')
            echo "Creado PR #$PR_NUMBER"
          else
            echo "Encontrado PR existente #$PR_NUMBER"
          fi

          # 3) Intentar activar auto-merge
          echo "Activando auto-merge en PR #$PR_NUMBER ..."
          if gh pr merge "$PR_NUMBER" --auto --merge; then
            echo "✔ Auto-merge activado"
            exit 0
          fi

          echo "⚠ No se pudo activar auto-merge ahora. Es probable que falten checks o protecciones."
